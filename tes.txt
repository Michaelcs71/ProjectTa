<?php
require_once $_SERVER['DOCUMENT_ROOT'] . "/ProjectTa/webservice/config.php";
require_once $_SERVER['DOCUMENT_ROOT'] . "/ProjectTa/lib/function.php";

// Fetch data
$data = Tampil_Data("hpp");
$selectedMonth = isset($_POST['month']) ? $_POST['month'] : '';
$selectedYear = isset($_POST['year']) ? $_POST['year'] : '';

if ($selectedMonth && $selectedYear) {
    $filteredData = array_filter($data, function ($item) use ($selectedMonth, $selectedYear) {
        $date = DateTime::createFromFormat('Y-m', $item->periode);
        return $date && $date->format('m') === $selectedMonth && $date->format('Y') === $selectedYear;
    });
} else {
    $filteredData = $data;
}
?>

<div class="main-content">
    <div class="page-content">
        <div class="container-fluid">
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-body">
                            <h4 class="text-center">PT. Fashion Ibu</h4>
                            <h5 class="text-center">Laporan Harga Pokok Produksi</h5>
                            <h6 class="text-center">Per 31 Desember <?= $selectedYear ?></h6>
                            <br>
                            <div id="printArea" style="border: 1px solid #ccc; padding: 20px; background-color: #f9f9f9;">
                                <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
                                    <tr>
                                        <td>Persediaan Awal</td>
                                        <td style="text-align: right;">Rp <?= number_format($filteredData[0]->persediaan_awal ?? 0, 0, ',', '.') ?></td>
                                    </tr>
                                    <tr>
                                        <td>Pendapatan Penjualan Bersih</td>
                                        <td style="text-align: right;">Rp <?= number_format($filteredData[0]->pendapatan_bersih ?? 0, 0, ',', '.') ?></td>
                                    </tr>
                                    <tr>
                                        <td>Pembelian Bersih</td>
                                        <td style="text-align: right;">Rp <?= number_format($filteredData[0]->pembelian_bersih ?? 0, 0, ',', '.') ?></td>
                                    </tr>
                                    <tr>
                                        <td>Biaya Overhead Pabrik</td>
                                        <td style="text-align: right;">Rp <?= number_format($filteredData[0]->biaya_overhead ?? 0, 0, ',', '.') ?></td>
                                    </tr>
                                    <tr>
                                        <td>Biaya Tenaga Kerja Langsung</td>
                                        <td style="text-align: right;">Rp <?= number_format($filteredData[0]->biaya_tenaga_kerja ?? 0, 0, ',', '.') ?></td>
                                    </tr>
                                    <tr>
                                        <td>Persediaan Akhir</td>
                                        <td style="text-align: right;">Rp <?= number_format($filteredData[0]->persediaan_akhir ?? 0, 0, ',', '.') ?></td>
                                    </tr>
                                    <tr style="border-top: 1px solid #ccc; font-weight: bold;">
                                        <td>Harga Pokok Penjualan</td>
                                        <td style="text-align: right;">Rp <?= number_format($filteredData[0]->hpp ?? 0, 0, ',', '.') ?></td>
                                    </tr>
                                    <tr style="font-weight: bold;">
                                        <td>Laba Kotor</td>
                                        <td style="text-align: right;">Rp <?= number_format($filteredData[0]->laba_kotor ?? 0, 0, ',', '.') ?></td>
                                    </tr>
                                    <tr>
                                        <td>Pajak (20%)</td>
                                        <td style="text-align: right;">Rp <?= number_format($filteredData[0]->laba_kotor * 0.2 ?? 0, 0, ',', '.') ?></td>
                                    </tr>
                                    <tr style="border-top: 2px solid #000; font-weight: bold;">
                                        <td>Laba Setelah Pajak</td>
                                        <td style="text-align: right;">Rp <?= number_format($filteredData[0]->laba_kotor * 0.8 ?? 0, 0, ',', '.') ?></td>
                                    </tr>
                                </table>
                            </div>
                            <br>
                            <form method="POST">
                                <select name="month" class="form-select">
                                    <option value="">Pilih Bulan</option>
                                    <?php for ($m = 1; $m <= 12; $m++) { ?>
                                        <option value="<?= str_pad($m, 2, '0', STR_PAD_LEFT) ?>" <?= $selectedMonth == str_pad($m, 2, '0', STR_PAD_LEFT) ? 'selected' : '' ?>>
                                            <?= date("F", mktime(0, 0, 0, $m, 10)) ?>
                                        </option>
                                    <?php } ?>
                                </select>
                                <select name="year" class="form-select">
                                    <option value="">Pilih Tahun</option>
                                    <?php for ($y = date("Y") - 10; $y <= date("Y"); $y++) { ?>
                                        <option value="<?= $y ?>" <?= $selectedYear == $y ? 'selected' : '' ?>><?= $y ?></option>
                                    <?php } ?>
                                </select>
                                <button class="btn btn-primary">Filter</button>
                            </form>
                            <br>
                            <button class="btn btn-secondary" onclick="printReport()">Cetak</button>
                            <button class="btn btn-success" onclick="downloadPDF()">Download PDF</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Tambahkan jsPDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
    // Fungsi untuk mencetak laporan
    function printReport() {
        const printContents = document.getElementById('printArea').innerHTML;
        const originalContents = document.body.innerHTML;
        document.body.innerHTML = printContents;
        window.print();
        document.body.innerHTML = originalContents;
    }

    // Fungsi untuk mengunduh laporan sebagai PDF
    function downloadPDF() {
        const {
            jsPDF
        } = window.jspdf;
        const doc = new jsPDF();

        // Ambil elemen untuk PDF
        const elementHTML = document.getElementById('printArea').innerHTML;

        // Tambahkan konten ke PDF
        doc.html(elementHTML, {
            callback: function(doc) {
                doc.save('Laporan_HPP.pdf');
            },
            x: 10,
            y: 10
        });
    }
</script>